# 使用

> 请确保已经按照[安装文档](INSTALL_zh.md)成功安装了本项目，然后再继续阅读本文档。

## 环境变量的设置

### 容器用户

对于使用容器构建的，请确保已经进入了容器环境，容器在构建时已经设置了环境变量，无需再次设置。

### 本地用户

而对于本地用户，有关的环境变量参考[安装文档](INSTALL_zh.md)中的说明，需要注意的是，终端中的环境变量设置仅对当前终端有效，如果需要永久设置，可以将环境变量写入到 `~/.bashrc` 或者 `~/.zshrc` 中。

## 使用前准备

### 循环描述文件

由于本项目对循环的解算无法做到完全的精确，因而为了确保测量的准确，请提供循环描述文件，文件格式如下：

```text
ndes_init|Loop in file ndes.c near line 75|BB#5:for.cond2<header><exiting>_BB#6:for.body4_BB#7:for.inc7<latch>|49
```


具体来说，格式为

```text
<函数名>|<循环描述>|<循环的基本块描述>|<循环的迭代次数>
```

### 循环描述文件的生成

由于上述文件全部手动编写是非常繁琐的，因而本项目提供了一个自动生成的[脚本](../testcases/run.py)，使用方法如下

```bash
cd testcases
./run.py -s <源代码所在目录> -o <输出文件目录> -p
```

其中 `-s` 为源代码所在目录，`-o` 为输出文件目录，`-p` 为是否打印循环描述文件。

这样生成的循环描述文件有两个，分别是 `LoopAnnotations.csv` 和 `LLoopAnnotations.csv`，前者表示循环上界，后者表示循环下界，请根据实际情况，将两个描述文件分别填写完成，具体来说，检查循环的边界是否设置正确，同时对于那些标注为 `-1` 的循环，将其修改为正确的循环边界。修改完成后，将这两个文件放置到和测试用例同一目录下。

### 核心描述文件

由于本项目针对的是多核处理器，因而需要提供核心描述文件，文件格式如下：

```json
[
    {
        "core": 0,
        "tasks": [
            {
                "function": "<函数名>"
            },
            {
                "function": "<函数名>"
            }
        ]
    },
    {
        "core": 1,
        "tasks": [
            {
                "function": "<函数名>"
            },
            {
                "function": "<函数名>"
            }
        ]
    },
    ...
]
```

其中，`core` 表示核心编号，`tasks` 表示该核心上的任务，`function` 表示任务所在的函数名。

## 使用

为方便使用，本项目提供了一个[脚本](../testcases/run.py)，使用方法如下

```bash
cd testcases
./run.py -s <源代码所在目录> -o <输出文件目录> [-t <临时文件目录>]
```

其中，`-t` 参数为可选参数，用于指定临时文件目录，如果不指定，则默认为 `dirforgdb`。

脚本默认会在源代码目录下搜索所需要的文件，包括循环描述文件和核心描述文件，如果找不到，则会报错。

## 结果

脚本运行完成后，会在指定的输出目录下生成 `WCET.json` 文件，格式如下

```json
{
    "system": {
        "core_count": <核心数量>
    },
    "tasks": [
        {
            "WCET": <最大执行时间>,
            "function": "<函数名>",
            "id": 0,
            "partition": <核心编号>
        },
        ...
    ]
}
```

其中，`WCET` 表示最大执行时间，`function` 表示函数名，`id` 表示任务编号，`partition` 表示核心编号。